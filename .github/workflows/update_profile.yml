name: Update Profile README

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  update_readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Update project lists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ambil daftar 5 repo terbaru, bersihkan deskripsi dari newline
          LATEST_REPOS_LIST=$(gh repo list Kyugito666 --sort=created --limit 5 --json name,url,description | jq -r '.[] | .description |= sub("[\\r\\n]+"; " "; "g") | "- **[\(.name)](\(.url))**: \(.description // "No description provided.")"')
          
          # Ambil daftar 5 repo terpopuler, bersihkan deskripsi dari newline
          POPULAR_REPOS_LIST=$(gh repo list Kyugito666 --sort=stars --limit 5 --json name,url,description,stargazersCount | jq -r '.[] | .description |= sub("[\\r\\n]+"; " "; "g") | "- **[\(.name)](\(.url))**: \(.description // "No description provided.") ‚≠ê \(.stargazersCount)"')

          # Simpan konten README saat ini
          CURRENT_README=$(cat README.md)

          # Hasilkan konten baru untuk Proyek Terbaru
          UPDATED_WITH_LATEST=$(awk -v replacement="$LATEST_REPOS_LIST" '
            BEGIN {
              p=1
            }
            // {
              print ""
              print replacement
              p=0
            }
            // {
              print ""
              p=1; next
            }
            p {
              print
            }
          ' <<< "$CURRENT_README")

          # Hasilkan konten final dengan Proyek Terpopuler
          FINAL_README=$(awk -v replacement="$POPULAR_REPOS_LIST" '
            BEGIN {
              p=1
            }
            // {
              print ""
              print replacement
              p=0
            }
            // {
              print ""
              p=1; next
            }
            p {
              print
            }
          ' <<< "$UPDATED_WITH_LATEST")
          
          # Tulis konten final ke file
          echo "$FINAL_README" > README.md

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(readme): auto-update project lists"
          file_pattern: README.md
